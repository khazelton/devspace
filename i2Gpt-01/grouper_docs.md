{
  "https://spaces.at.internet2.edu/display/Grouper/Grouper+provisioning+framework": "| [Wiki Home](https://spaces.at.internet2.edu/display/Grouper/Grouper+Wiki+Home) | [Grouper Release Announcements](/display/Grouper/Grouper+Release+Announcements) | [Grouper Guides](/display/Grouper/Grouper+Administration+Guides) | [Grouper Deployment Guide](/display/Grouper/Grouper+Deployment+Guide) | [Community Contributions](https://spaces.at.internet2.edu/display/Grouper/Community+Contributions) | [Internal Developer Resources](/display/GrIntDev/Grouper+Internal+Development+Home) |\n| --- | --- | --- | --- | --- | --- |\n\n**This page is your starting point for the Grouper provisioning framework in Grouper v4+.**See the [Versioning](/pages/viewpage.action?pageId=41582755) page for clarification on Grouper version numbering.\n\nFor background, see these blogs\n\n* [New Provisioning Framework blog - January 2021](https://incommon.org/news/flexible-and-powerful-to-address-community-needs-new-grouper-provisioning-framework/)\n* [News from the Grouper Project blog - November 2021](https://incommon.org/news/news-from-the-grouper-project/?_ga=2.254687115.2072662432.1658943707-1153598486.1658943707&_gl=1*mnmv7t*_ga*MTE1MzU5ODQ4Ni4xNjU4OTQzNzA3*_ga_8P1JY9SZF0*MTY1OTAxNDY4NS41LjEuMTY1OTAxNTA3Ny4w)\n* [Major Improvements to the Grouper Provisioning Framework - February 2023](https://incommon.org/news/major-improvements-to-the-grouper-provisioning-framework/)\n\n[Provisioning Glossary](/display/Grouper/Grouper+provisioning+glossary)\n\nOverview of features\n--------------------\n\nKey features of the provisioning framework:\n\n* All parts of provisioning configuration are performed in the  [Grouper UI](/display/Grouper/Grouper+provisioning+in+UI) with helpful documentation, wizard-like interfaces, descriptive [validations](/display/Grouper/Grouper+provisioning+validation), and diagnostic tests.\n* All provisioners have consistent [configuration concepts](/display/Grouper/Grouper+generic+provisioning+configuration) and terms so adding the next provisioner will be easy.\n* Configuring new provisioners or editing existing provisioners do not require Grouper to be redeployed/restarted.\n* [Provisioning configuration](/display/Grouper/Grouper+generic+provisioning+configuration) starts with an “external system”, which is the connection information to connect to the target to provisioning to.\n* [External systems](/display/Grouper/Grouper+External+systems+configuration) can be re-used among provisioners, or for other parts of Grouper (e.g. loader, “custom UI”). The provisioner itself is configured next.\n* [Scaffolding (start with)](/pages/viewpage.action?pageId=219914238)  can help you get started with provisioning configuration.\n* There are the [daemon jobs](/display/Grouper/Grouper+Daemon) for the full or incremental sync which are scheduled.\n* All provisioners have a standard object model. [Translating](/display/Grouper/Grouper+provisioning+translations) data from Grouper to the target format is consistent across all provisioners.\n* You configure which data from Grouper gets sent to the target and how it is formatted\n* There are provisioning-specific screens to identify which objects (groups, users, memberships, attributes) are sent to the target.\n* Provisioner specific [metadata](/display/Grouper/Grouper+provisioning+custom+metadata) can be assigned to Grouper objects to inform provisioning actions.\n* When the provisioner is up and running, data propagation is  verified and errors info is readily available\n\nWhen asking for support\n-----------------------\n\nTurn on \"Log all objects verbose\" to DB under advanced in provisioning configuration.  You can optionally also enter in a group name and subject id to focus on.\n\nDo a provisioning run that shows an error\n\nGo to the daemon log for that run, scroll to the right, and copy the full output, send in slack snippet to incommon-grouper (or to Chris Hyzer if private info)\n\nNote, if you are doing a large run you might want to turn off command logging\n\nExport the grouper-loader properties file from UI.  Take the section for that provisioner (no need to send configs for daemon).  Send that along too.\n\nReport which version your Grouper is.\n\nIf the external system is involved, send relevant non private info too.\n\nHigh level design\n-----------------\n\n![grouperProvisioningHighLevel3](/download/attachments/159978720/grouperProvisioningHighLevel3.png?version=1&modificationDate=1634797879168&api=v2)\n\n**Notes on High Level Design diagram**\n\n1. The provisioner has CRUD (Create Read Update Delete) operations implemented for the endpoint.\n   1. Note: there is a concept of an \"external system\" in Grouper.  Perhaps some or all of the CRUD is implemented in the \"External System\".  Perhaps the external system builds on top of an External System\n   2. Its possible to integrate ConnID here or wrap around it in the future\n2. There is an object model for [TargetGroup, TargetSubject, TargetMembership, TargetAttribute](https://github.com/Internet2/grouper/tree/master/grouper/src/grouper/edu/internet2/middleware/grouper/provisioning).\n   1. The Provisioner instance can use the built in Target objects or can subclass those as needed\n   2. Note: \"Target attribute\" is just the object model for being able to have arbitrary fields in target groups, subjects, and memberships.  Its not really related to the attribute framework though it could probably be translated from it\n3. The Custom Provisioner Implementation extends the [Base implementation](https://github.com/Internet2/grouper/blob/master/grouper/src/grouper/edu/internet2/middleware/grouper/provisioning/TargetProvisionerBase.java), and has methods for whatever is necessary.  The Base provisioner has built in logic:\n   1. Deal with Grouper objects\n   2. Compute what needs to be inserted/updated/deleted\n   3. Do the logging and error handling\n   4. Interface with [\"Sync\" objects](https://spaces.at.internet2.edu/pages/viewpage.action?pageId=163119922)\n   5. Triggered from real time change log, full sync daemon, and UI to fix one-offs\n   6. Interface with UI so provisioning state is known by users or people troubleshooting\n4. The provisioner uses standard configuration\n   1. The UI will configure the provisioner via wizard.  Has standard [validation](/display/Grouper/Grouper+provisioning+configuration+validation) and documentation.  This is a pass through to grouper-loader.properties configs in the database.  You can configure directly in config files instead if you like (not recommended)\n      1. Option for grouperIsAuthoritative to delete objects not in Grouper\n   2. There is standard [configuration for external systems](https://spaces.at.internet2.edu/display/Grouper/External+systems+configuration) with wizards\n   3. [Configuration for daemons](https://spaces.at.internet2.edu/display/Grouper/Daemon+configuration) (real time and full sync)\n5. The real time change log consumer has a [workflow built for provisioning](https://spaces.at.internet2.edu/display/Grouper/Grouper+provisioning+incremental+workflow)\n   1. Compute which events really need to be processed\n   2. Convert between individual events and group-sync or full-sync\n   3. Reduces the amount of logic needed in provisioners\n   4. Check message queue for UI events to fix a membership or group etc\n   5. Check message queue for \"async\" computations.  i.e. a full sync that runs in the background and doesn't block other processes and sends messages to fix certain suggested objects\n   6. Note, this runs as Java in the Grouper Daemon, not as an async provisioner.  This is so we can tightly couple and keep track of things and not require extra processes\n6. The real time change log for provisioners will consult the [\"sync\" tables](https://spaces.at.internet2.edu/pages/viewpage.action?pageId=163119922) to see if a task is already done, see if it is provisionable, etc\n7. The full sync daemon runs as asynchronous or synchronous.  Generally it is probably ok to run daily off hours as synchronous, but maybe an async run will be sufficient.\n   1. Synchronous runs will block other processing, and uses the \"sync tables\" to block.  This allows daemons to run on multiple servers and not need to run multiple times\n   2. Asynchronous runs will not block and will send messages for individual objects to check, or will see there are so many updates it requires a blocking full sync\n   3. Full syncs will bulk fetch from Grouper and the Target system (if the API supports it) and process everything in a short amount of time but using a lot of resources (e.g. memory).  Note its possible that there is batch size to reduce the resources needed and not need as much resources.\n   4. Full syncs will also try to batch inserts/updates/deletes (if API supports it)\n   5. Note, this runs as Java in the Grouper Daemon, not as an async provisioner.  This is so we can tightly couple and keep track of things and not require extra processes\n8. Full syncs will bulk fetch from sync tables to consult and true up what Grouper thinks the state of the target system is\n   1. Errors will trigger a recalc where cached data is ignored and updated as the real underlying data is fetched from grouper, subject source, and target system.  There are options to take into consideration e.g. grouperIsAuthoritative\n9. There is a new format for provisioning attributes on groups and folders.  This format precalculates inheritance and has more options than the legacy PSPNG attributes\n   1. Grouper will be able to migrate from one format to the new\n   2. All provisioners will use standard provisioning attributes\n   3. It is possible to use these attributes to override where an object is provisioned in the target (e.g. point a group or folder at a different OU in ldap\n   4. This data (if provisionable and where) is copied to the \"sync tables\" so that there are no foreign keys and PIT is not needed when a group/member/membership is deleted\n10. Grouper tables have Grouper's state for groups and memberships.  Again as these are deleted or moved, the sync tables can facilitate efficient and accurate provisioning\n11. Sync tables keep a [copy of state](https://spaces.at.internet2.edu/pages/viewpage.action?pageId=163119922) that does not have a foreign key to groups/members/memberships.  There is a table for\n    1. Provisioner\n    2. Job (e.g. full or real time)\n    3. Sync group: cache state from Grouper and Target.  Is provisionable.  Some stats.  Timestamps.  Error messages\n    4. Sync member: cache state from Grouper and Target.  Is provisoinable.  Some stats.  Timestamps.  Error messages\n    5. Sync membership: cache state from Grouper and Target.  Is provisionable.  Some stats.  Timestamps.  Error messages\n    6. Log: keep log messages temporarily about a sync of a job/group/member/membership\n12. Provisioning targets that need subject data might not use the subject ID or identifier in the member table, or might use other attributes\n    1. The new USDU will resolve all subjects from all subject sources nightly, and while that data is being processed, the sync tables can be updated for what that provisioner needs\n    2. Might need a different identifier\n    3. Might need other attributes stored in JSON\n13. The provisioner uses the sync table data to make provisioning more efficient, communicate and keep track of errors, log progress, survive Grouper object deletion\n14. There is translation between the Grouper id's and names, the Target id's and names, and the Subject API id's and names\n    1. Hopefully most of that can be handled with EL scripts\n    2. Whatever is needed for the translation needs to be cached in sync tables (that is configurable)\n\nData Model diagram\n------------------\n\n![grouperDataModel2](/download/attachments/159978720/grouperDataModel2.png?version=1&modificationDate=1634797939291&api=v2)\n\n**Notes on Data Model diagram**\n\n1. The [DAO](/display/Grouper/Grouper+provisioning+target+DAO) is how Java talks to the target.  This would implement CRUD operations and hopefully do so in bulk\n2. \"Target beans\" can be subclassed if needed\n3. The provisioner specifies the class names of all the mandatory and optional subclasses\n4. The logic is what takes the beans and decides what has changed and runs the actions to sync or notify or log\n5. The configuration class will translate from the properties file to java, and validate the configuration\n6. The translator will translate from Grouper objects to Target objects (and vise versa), based on configuration and potentially cache\n7. The Grouper DAO will get objects from Grouper efficiently based on which field is being retrieved\n8. The target classes can be subclassed for Grouper\n9. The Subject DAO will get objects from the subject source\n10. The target objects for subjects can be subclassed\n\nProvisioning tasks (for more [detail see this page](#))\n-------------------------------------------------------\n\n| Task | Description | Status |\n| --- | --- | --- |\n| Ldap Dao | New interface implementation for efficient LDAP operations | In progress |\n| External systems in UI | Endpoints, usernames, passwords, with wizards in UI | In progress |\n| New [USDU](/pages/viewpage.action?pageId=14517820) daemon | Resolve all subjects, update unresolvable status, and cache provisioning sync attributes | Almost started |\n| Provisioning configuration in UI | Mark folders and groups as provisionable and provide specific configuration | Done |\n| Provisioning change log consumer | Look at \"sync\" objects and provide provisioner with \"processed\" view of work to do | Done |\n| Shadow objects in database | \"sync\" tables keep track of target system status and cache attribute | Done |\n\nTargets\n-------\n\n* [LDAP](/display/Grouper/Grouper+LDAP+provisioner)\n* SQL\n* SCIM\n* google\n* drop box (SCIM?) (todo)\n* box\n* [Duo](/display/Grouper/Grouper+Duo+provisioning)\n* azure / o365\n* zoom (todo)\n* slack (SCIM?) (todo)\n* servicenow (jeffW) (todo)\n* canvas (Unicon) (todo)\n* adobe (jeffW, liam) (todo)\n* teamDynamix (liam) (todo)\n* remedy\n* papercut (liam) (todo)\n* tableau (liam) (todo)\n* salesforce (liam) (todo)\n\nExport a config\n---------------\n\nIf you are reporting an issue with the provisioning framework, please follow these steps:\n\n1. Ensure you are on a recent supported release of Grouper\n2. Report your version number\n3. Send sanitized configs for the provisioner either to the list or to a Grouper developer in a private slack\n   1. Export your grouper-loader.properties from the UI\n   2. Search for your provisioner config id\n   3. Send that block of configs\n   4. No need to send the daemon configs\n   5. If there is a problem making calls to the target you might want to send the sanitized (no passwords or keys) configs of the external system for the provisioner\n\nProvisioning in LDAP/AD\n-----------------------\n\nSee the [info here](/display/Grouper/Grouper+LDAP+provisioner).\n\nProvisioning to SQL\n-------------------\n\nSee the info [here](/display/Grouper/Grouper+SQL+provisioner)\n\nProvisioning to SCIM\n--------------------\n\nSee [this page](/display/Grouper/Grouper+provisioning+SCIM)\n\nProvisioning to Box\n-------------------\n\nSee [this page](/display/Grouper/Grouper+Box+Provisioner)\n\nProvisioning to Azure\n---------------------\n\nSee [this page](/display/Grouper/Grouper+Entra+ID+Provisioner+%28Current%29+Azure+O365)\n\nProvisioning to other systems\n\nYou could implement your own provisioner or use the provisioning framework to send messages\n\nSee Also\n--------\n\n* [Grouper provisioners](/display/Grouper/Grouper+provisioners)\n* [Grouper provisioning examples](/display/Grouper/Grouper+provisioning+examples)\n* [Grouper provisioning features](/display/Grouper/Grouper+provisioning+features)\n* [Grouper provisioning in UI](/display/Grouper/Grouper+provisioning+in+UI)\n* [Grouper provisioning technical](/display/Grouper/Grouper+provisioning+technical)\n* [Grouper provisioning glossary](/display/Grouper/Grouper+provisioning+glossary)",
  "https://spaces.at.internet2.edu/display/Grouper/Grouper+Loader": "| [Wiki Home](https://spaces.at.internet2.edu/display/Grouper/Grouper+Wiki+Home) | [Grouper Release Announcements](/display/Grouper/Grouper+Release+Announcements) | [Grouper Guides](/display/Grouper/Grouper+Administration+Guides) | [Grouper Deployment Guide](/display/Grouper/Grouper+Deployment+Guide) | [Community Contributions](https://spaces.at.internet2.edu/display/Grouper/Community+Contributions) | [Internal Developer Resources](/display/GrIntDev/Grouper+Internal+Development+Home) |\n| --- | --- | --- | --- | --- | --- |\n\n### Grouper Loader - What is it?\n\nA Loader is a task, or a job, that runs on a schedule that pulls users from a data source into Grouper memberships. There are several types of Loader that can be used to pull information from various sources. The types of loader (which correspond to their data source) are as follows: JEXL Script, SQL, LDAP, and Recent Membership. To see where Loaders fit into the architectural landscape please view the following diagram: [architectural diagram](/download/attachments/14517787/GrouperLoaderArchitectureDiagram.tiff?version=1&modificationDate=1333884346946&api=v2).\n\n[Grouper Diagnostics](/pages/viewpage.action?pageId=14517917).\n\n![](/download/attachments/14517787/image2018-1-26_2-14-13.png?version=1&modificationDate=1516950853794&api=v2)\n\n* [Grouper GSH script daemon loader for attributes and values](/display/Grouper/Grouper+GSH+script+daemon+loader+for+attributes+and+values)\n* [Grouper GSH script daemon loader from Google sheet](/display/Grouper/Grouper+GSH+script+daemon+loader+from+Google+sheet)\n* [Grouper - Loader Administration](/display/Grouper/Grouper+-+Loader+Administration)\n* [Grouper - Loader Configuration Examples](/display/Grouper/Grouper+-+Loader+Configuration+Examples)\n* [Grouper - Loader GSH](/display/Grouper/Grouper+-+Loader+GSH)\n* [Grouper - Loader LDAP](/display/Grouper/Grouper+-+Loader+LDAP)\n* [Grouper Loader permissions or attributes POC with GSH](/display/Grouper/Grouper+Loader+permissions+or+attributes+POC+with+GSH)\n* [Grouper - Loader SQL Simple](/display/Grouper/Grouper+-+Loader+SQL+Simple)\n* [Grouper loader with CSV data sources](/display/Grouper/Grouper+loader+with+CSV+data+sources)\n* [Organization hierarchies via the grouper loader](/display/Grouper/Organization+hierarchies+via+the+grouper+loader)\n\n### Things to keep in mind with Loaders:\n\n### Ad hoc groups with the Grouper Loader\n\n![](/download/attachments/14517787/image2018-1-26_2-14-50.png?version=1&modificationDate=1516950891037&api=v2)\n\n![](/download/attachments/14517787/image2018-1-26_2-15-28.png?version=1&modificationDate=1516950928363&api=v2)\n\n#### Loader manages simple group or a list of groups in one job\n\n![](/download/attachments/14517787/image2018-1-26_2-16-17.png?version=1&modificationDate=1516950977389&api=v2)\n\n#### One-time setup in your Grouper database\n\nTo make a dynamic (loadable) group, first you need the correct metadata in Grouper. The easiest way is to set the grouper-loader.properties key loader.autoadd.typesAttributes to true.  If you don't want to do that, then here is the setup in [GSH](https://spaces.at.internet2.edu/display/Grouper/GrouperShell+%28gsh%29):\n\n```\nsubj=SubjectFinder.findById(\"GrouperSystem\")\nsess=GrouperSession.start(subj)\ntype=GroupType.createType(sess, \"grouperLoader\")\ntype.addAttribute(sess, \"grouperLoaderType\", false)\ntype.addAttribute(sess, \"grouperLoaderDbName\", false)\ntype.addAttribute(sess, \"grouperLoaderScheduleType\", false)\ntype.addAttribute(sess, \"grouperLoaderQuery\", false)\ntype.addAttribute(sess, \"grouperLoaderQuartzCron\", false)\ntype.addAttribute(sess, \"grouperLoaderIntervalSeconds\", false)\ntype.addAttribute(sess, \"grouperLoaderPriority\", false)\ntype.addAttribute(sess, \"grouperLoaderAndGroups\", false)\ntype.addAttribute(sess, \"grouperLoaderGroupTypes\", false)\ntype.addAttribute(sess, \"grouperLoaderGroupsLike\", false)\ntype.addAttribute(sess, \"grouperLoaderGroupQuery\", false)\ntype.addAttribute(sess, \"grouperLoaderDisplayNameSyncType\", false)\ntype.addAttribute(sess, \"grouperLoaderDisplayNameSyncBaseFolderName\", false)\ntype.addAttribute(sess, \"grouperLoaderDisplayNameSyncLevels\", false)\n\n\n```\n\n Note that a loadable group has the type \"grouperLoader\", and there are some attributes that you can set about the group:\n\n* [**grouperLoaderType**](http://anoncvs.internet2.edu/cgi-bin/viewvc.cgi/grouper-ext/grouper-loader/src/grouper-loader/edu/internet2/middleware/grouper/loader/GrouperLoaderType.java?root=I2MI&view=markup): there will be various types to choose from, currently only these are available :\n  + SQL\\_SIMPLE is a group whose membership is fed from a query, and the whole query's results will be the groups results (not incremental).\n  + SQL\\_GROUP\\_LIST requires a group\\_name column in query, so one query can control multiple group memberships.  This will default to SQL\\_SIMPLE if no group\\_name before the FROM in the query.  Else it will be SQL\\_GROUP\\_LIST.\n\n* **grouperLoaderDbName**: if it is a sql based type, this is the name in the grouper-loader.properties of the db connection properties.  If this is set to the reserve value \"grouper\"  it will use the grouper db (in grouper.hibernate.properties). Here is a snippet from grouper-loader.properties where grouperLoaderDbName=warehouse :\n\n```\n# specify the db connection with user, pass, url, and driver class\n# the string after \"db.\" is the name of the connection, and it should not have\n# spaces or other special chars in it\ndb.warehouse.user = mylogin\ndb.warehouse.pass = secret\ndb.warehouse.url = jdbc:mysql://localhost:3306/grouper\ndb.warehouse.driver = com.mysql.jdbc.Driver\n\n```\n\n* [**grouperLoaderScheduleType**](http://anoncvs.internet2.edu/cgi-bin/viewvc.cgi/grouper-ext/grouper-loader/src/grouper-loader/edu/internet2/middleware/grouper/loader/GrouperLoaderScheduleType.java?root=I2MI&view=markup): Grouper-loader uses the quartz open source job scheduler, and currently supports two schedule types:\n  1. CRON: This is a [cron-like syntax that I think is quartz specific](http://www.quartz-scheduler.org/documentation/quartz-1.x/tutorials/crontrigger)\n  2. START\\_TO\\_START\\_INTERVAL: This is a repeated schedule that runs based on a delay from the start of one run to the start of another run\n\nThis defaults to CRON if there is a value for grouperLoaderQuartzCron (see below), else it defaults to START\\_TO\\_START\\_INTERVAL. *Note that a job will not start if a previous run has not finished*.\n\n* **grouperLoaderQuery**: This is the query to run in the DB, which must have certain columns required or optional based on the grouperLoaderType.  e.g. for SQL\\_SIMPLE, the SUBJECT\\_ID is required, and the SUBJECT\\_SOURCE\\_ID is optional.  If your DB supports views, might not be a bad idea to link query up to a view so you can easily see what it will return and change it without affecting the group attribute.  But will work with any select query.  This is required.  Note: in Grouper v2.1 you can try having SUBJECT\\_IDENTIFIER or SUBJECT\\_ID\\_OR\\_IDENTIFIER instead of SUBJECT\\_ID, though each is less efficient than the next since they require an extra subject lookup or multiple subject lookups per row. SQL\\_GROUP\\_LIST requires a group\\_name column in query,\n* **grouperLoaderQuartzCron**: If a CRON schedule type, this is the cron setting string from the quartz product to run a job daily, hourly, weekly, etc: <http://www.opensymphony.com/quartz/wikidocs/TutorialLesson6.html>\n* **grouperLoaderIntervalSeconds**: If a START\\_TO\\_START\\_INTERVAL schedule type, this is the number of seconds between the start of one run to the start of another run.  This defaults to daily if not filled in.  Note, for daily jobs, it is probably better to use cron so it won't fire up each time the loader is restarted.\n* **grouperLoaderPriority**: Quartz has a fixed threadpool (max configured in the grouper-loader.properties), and when the max is reached, then jobs are prioritized by this integer.  The higher the better, and the default if not set is 5.\n* **grouperLoaderAndGroups**: If you want to restrict membership in the dynamic group based on other group(s), put the list of group names here comma-separated.  The require groups means if you put a group names in there (e.g. school:community:employee) then it will \"and\" that group with the member list from the loader.  So only members of the group from the loader query who are also employees will be in the resulting group\n* **grouperLoaderGroupTypes**: whatever you put in the value should be comma separated GroupTypes which will be applied to the loaded groups.  The reason this enhancement exists is so we can do a SQL\\_GROUP\\_LIST query and attach addIncludeExclude to the groups.  Note, if you do this (or use some requireGroups), the group name in the loader query should end in the system of record suffix, which by default is \\_systemOfRecord.\n  + To use the \"addIncludeExclude\" GroupType you need to set `grouperIncludeExclude.use = true` in grouper.properties\n\n* **grouperLoaderGroupsLike**: this should be a sql like string (e.g. school:orgs:%org%\\_systemOfRecord), and the loader should be able to query group names to see which names are managed by this loader job.  So if a group falls off the loader resultset (or is moved), this will help the loader remove the members from this group.  Note, if the group is used anywhere as a member or composite member, it won't be removed.  All include/exclude/requireGroups will be removed.  Though the two groups, include and exclude, will not be removed if they have members.  There is a grouper-loader.properties setting to note remove loader groups if empty and not used:\n\n```\n#if using a sql table, and specifying the name like string, then should the group (in addition to memberships)\n# be removed if not used anywhere else?\nloader.sqlTable.likeString.removeGroupIfNotUsed = true\n\n```\n\n* **grouperLoaderGroupQuery**: query (optional) for SQL\\_GROUP\\_LIST which should return cols: group\\_name (full path of the group), group\\_display\\_name (optional, will be used for group display name), group\\_description (optional, will default to \"<extension> auto-created by grouperLoader\" unless loader.allowBlankGroupDescriptions is set to true in grouper-loader.properties).  Note: the parent stem display names are only changed when creating them.  This should return all groups in the membership list, and if not there, its ok, the extension will be used as display extension, and a generated description. Note: the display name is the display path, with the display extension of each parent stem.  If there is a column named any of the following: readers, viewers, admins, updaters, optins, optouts, group\\_attr\\_readers, group\\_attr\\_updaters, then the data in the column (comma separated subjectId's or subjectIdentifers (which can include group names) will be assigned to that privilege list.  Note, existing assignments to that privilege list will not be removed, so if you remove an item from the query, you will need to manually remove it from the groups.  This is a way to have a loaderJob-wide list of readers or viewers.\n\n* **grouperLoaderDisplayNameSyncType:** (optional attribute) - (v2.5.53+) This attribute allows syncing folder display extensions between source and grouper. This attribute is for SQL\\_GROUP\\_LIST and can only be set when grouperLoaderGroupQuery is set.  Pick which type of display name sync.  By default Grouper will assign the display name of a folder but then not change it in future.  Grouper will by default change group display extensions as they change in the loader group query.\n* **grouperLoaderDisplayNameSyncBaseFolderName:** (v2.5.53+) Base folder system name after which you would like to sync folders display extensions between source and grouper. Specify (e.g a:b:c) after which you want the loader to sync display names as well. Also, if you specify 'root' as the base folder name, then all the folder extensions will sync.  This is a good option if all your groups are in a certain base folder and you want all folder display extensions under that to sync.\n* **grouperLoaderDisplayNameSyncLevels:** (v2.5.53+) Levels of which you would like to sync folders display names between source and grouper.  It means you would specify an integer value that represents the level starting from 1 for the group extension. The higher you go up, the more nodes will sync. For example, if a group's path is a:b:c:d:group1 and levels value is 3, display names will sync starting from folder c. If you want to sync everything for this example, choose 5 or higher (or set 'root' ingrouperLoaderDisplayNameSyncBaseFolderName).\n\n#### Configure a loadable group (obviously any number of dynamic loadable groups can exist at once)\n\nWith GSH, it would look like this:\n\n```\ngroup=getGroups(\"aStem:aGroup2\")\ngroupAddType(\"aStem:aGroup2\", \"grouperLoader\")\nsetGroupAttr(\"aStem:aGroup2\", \"grouperLoaderDbName\", \"grouper\")\nsetGroupAttr(\"aStem:aGroup2\", \"grouperLoaderType\", \"SQL_SIMPLE\")\nsetGroupAttr(\"aStem:aGroup2\", \"grouperLoaderScheduleType\", \"START_TO_START_INTERVAL\")\nsetGroupAttr(\"aStem:aGroup2\", \"grouperLoaderQuery\", \"select SUBJECT_ID, SUBJECT_SOURCE_ID from agroup2_v\")\nsetGroupAttr(\"aStem:aGroup2\", \"grouperLoaderIntervalSeconds\", \"30\")\n\n```\n\nYou can also use the UI, here are screenshots (obviously these need some work).\n\n![](/download/attachments/14517787/groupEdit.gif?version=1&modificationDate=1257179085731&api=v2)\n\n![](/download/attachments/14517787/groupAttributeEdit.gif?version=1&modificationDate=1257179085732&api=v2)\n\n#### Run grouper daemon\n\nThe first time you run, it will probably fail, and give you DDL in the logs to run in your database (to add a couple of tables).  Run the scripts and you should be all set.\n\nRun with:\n\n```\n GROUPER_HOME/bin/gsh.sh -loader\n\n```\n\nThis will kick off as a command line program that you will want to run as a service.  This process will be always running, and the scheduler will schedule the jobs.  You should monitor the process with a monitoring tool like nagios or whatever you use at your institution so that you know when it is not up.\n\nYou can also run a one-timer via gsh.  This is useful to run once at the beginning, and not have to wait for the schedule.  Or to troubleshoot e.g.\n\n```\nloaderGroup = GroupFinder.findByName(GrouperSession.startRootSession(), \"school:orgs:orgGroup\");\nloaderRunOneJob(loaderGroup);\nloaderRunOneJob(\"MAINTENANCE_cleanLogs\");\n\n```\n\nNote that as of Grouper 2.3, if you create a new loader job, you can have it scheduled without restarting the daemon by using an option in the New UI.  If you're an admin of the group, under \"More actions\", there's an option named \"Schedule loader process\".  This option can also be used if you change the loader's schedule.\n\n#### Groups as members\n\nIf you are using the loader to load hierarchies where groups are members, then you need to have a query which has the column SUBJECT\\_IDENTIFIER with the group system name, or SUBJECT\\_ID with the group uuid.  Useful for org charts.  See [this example](/display/Grouper/Grouper+Loader+classlist+example+from+Penn)\n\n#### Logging of jobs in DB\n\nEach job (and subjob if the job manages multiple things) will have an entry in the grouper\\_loader\\_log table.  This will show the following information.  This can be used to tune performance problems, see which jobs have unresolvable subjects, verify that jobs are running, etc.\n\n```\nCOLUMN_NAME    \t\t\t\tDATA_TYPE\n\nID    \t\t\t\t\t\t\tVARCHAR2\nJOB_NAME                                            VARCHAR2\nSTATUS                                               VARCHAR2\nSTARTED_TIME                                     TIMESTAMP(6)\nENDED_TIME    \t\t\t\t\t   TIMESTAMP(6)\nMILLIS    \t\t\t\t\t       NUMBER\nMILLIS_GET_DATA    \t\t\t\tNUMBER\nMILLIS_LOAD_DATA    \t\t\t       NUMBER\nJOB_TYPE    \t\t\t\t\t     VARCHAR2\nJOB_SCHEDULE_TYPE    \t\t\t      VARCHAR2\nJOB_DESCRIPTION    \t\t\t\tVARCHAR2\nJOB_MESSAGE    \t\t\t\t\t  VARCHAR2\nHOST    \t\t\t\t\t\tVARCHAR2\nGROUP_UUID    \t\t\t\t\t  VARCHAR2\nJOB_SCHEDULE_QUARTZ_CRON    \t\tVARCHAR2\nJOB_SCHEDULE_INTERVAL_SECONDS        NUMBER\nJOB_SCHEDULE_PRIORITY    \t\t   NUMBER\nLAST_UPDATED    \t\t\t\t TIMESTAMP(6)\nUNRESOLVABLE_SUBJECT_COUNT    \t      NUMBER\nINSERT_COUNT    \t\t\t\t NUMBER\nUPDATE_COUNT    \t\t\t\tNUMBER\nDELETE_COUNT    \t\t\t\t NUMBER\nTOTAL_COUNT    \t\t\t\t\t NUMBER\nPARENT_JOB_NAME    \t\t\t\tVARCHAR2\nPARENT_JOB_ID    \t\t\t\t  VARCHAR2\n\n```\n\nYou can also look at log4j debug log messages, and info log messages (less frequent).  to see these, set log level in log4j.properties\n\n## Log debug info on loader to see progress etc  \nlog4j.logger.edu.internet2.middleware.grouper.app.loader = INFO  \n-or-  \nlog4j.logger.edu.internet2.middleware.grouper.app.loader = DEBUG\n\n#### Misc\n\n* You can set transaction level in the grouper-loader.properties.  It defaults to not use transaction since for huge groups, you might have memory or db problems\n* By default only wheel group members can edit the grouperLoader type or attributes.  You can edit these settings in the grouper.properties in the type security part.\n\n#### Example test proving that only certain members can edit loader attributes\n\ngrouper.properties:\n\n```\nsecurity.types.grouperLoader.wheelOnly = false\n\nsecurity.types.grouperLoader.allowOnlyGroup = etc:someAdminGroup\n\nwheel configured:\n\ngroups.wheel.use                      = true\n\n# Set to the name of the group you want to treat as the wheel group.\n# The members of this group will be treated as root-like users.\ngroups.wheel.group                    = etc:sysadmingroup\n\n```\n\ncreate the security group in gsh\n\n```\ngrouperSession = GrouperSession.startRootSession();\n\nsomeSysAdminGroup = new GroupSave(grouperSession).assignName(\"etc:someAdminGroup\").assignGroupNameToEdit(\"etc:someAdminGroup\").save();\n\n```\n\nmake sure subject not wheel\n\n```\ngsh 9% hasMember(\"etc:sysadmingroup\", \"test.subject.0\");\nfalse\n\n```\n\nadd a group for that user to be an admin of (GSH)\n\n```\nsomeGroup = new GroupSave(grouperSession).assignName(\"a:b\").assignGroupNameToEdit(\"a:b\").assignCreateParentStemsIfNotExist(true).save();\n\ngrantPriv(\"a:b\", \"test.subject.0\", AccessPrivilege.ADMIN);\n\n```\n\nauto add attributes in grouper-loader.properties\n\n```\n# auto-add grouper loader types and attributes when grouper starts up if they are not there\nloader.autoadd.typesAttributes = true\n\n```\n\nstart the loader to init the attributes (command line)\n\n```\ngsh -loader\n\n```\n\nlogin to UI as test.subject.0, Try to add grouperLoader type to group, and get this error:\n\n```\nError: This operation is not allowed: Not allowed to edit type: grouperLoader, adding type since the user Subject id: test.subject.0, sourceId: jdbc is not in group: etc:someAdminGroup.\n\n```\n\nIn the UI see that the type is not assigned.  Check the DB if you don't believe:\n\n```\nSELECT * FROM grouper_groups_types_v WHERE group_name = 'a:b'\n\n```\n\nVerify the SQL, when I look in grouperSql.log, I see these SQLs:\n\n```\nupdate grouper_groups set hibernate_version_number=1, parent_stem='088956f34e064116b68b97198ea422f7', creator_id='233cdc87a0654c03b37e59ea0bc7b52c', create_time=1273197358184, modifier_id='9221f2ae35d44d23b7bdb469e9e96278', modify_time=1273198909003, name='a:b', display_name='a:b', extension='b', display_extension='b', description=null, context_id='29523c8d2dac4ddd8294c40fadfd0f7f', alternate_name=null, type_of_group='group' where id='6e70a1c3a2d246669244051e44439374' and hibernate_version_number=0\n2010/05/06 22:21:49:003, 0ms, statement: ByObjectStatic.java.saveOrUpdate() line 327, Hib3AuditEntryDAO.java.saveOrUpdate() line 26, AuditEntry.java.saveOrUpdate() line 307, Group.java.callback() line 3900, Group.java.store() line 3826, SaveGroupAction.java.grouperExecute() line 237, GrouperCapableAction.java.callback() line 217, Hib3TransactionDAO.java.callback() line 51, Hib3TransactionDAO.java.transactionCallback() line 41, GrouperCapableAction.java.grouperTransactionExecute() line 214, GrouperCapableAction.java.execute() line 279, LoginCheckFilter.java.callback() line 173, GrouperSession.java.callbackGrouperSession() line 644, LoginCheckFilter.java.doFilter() line 168, ErrorFilter.java.doFilter() line 132, GrouperUiFilter.java.doFilter() line 398\n   insert into grouper_audit_entry (hibernate_version_number, act_as_member_id, audit_type_id, context_id, created_on, description, env_name, grouper_engine, grouper_version, int01, int02, int03, int04, int05, last_updated, logged_in_member_id, server_host, string01, string02, string03, string04, string05, string06, string07, string08, duration_microseconds, query_count, user_ip_address, server_user_name, id) values (0, null, 'd087478a3a334c41a104a9a0b47e2b3e', '29523c8d2dac4ddd8294c40fadfd0f7f', 1273198909003, 'Updated group: a:b, Fields changed: none', '', 'grouperUI', '1.5.3', null, null, null, null, null, 1273198909003, '9221f2ae35d44d23b7bdb469e9e96278', 'mchyzer-PC', '6e70a1c3a2d246669244051e44439374', 'a:b', '088956f34e064116b68b97198ea422f7', 'a:b', '', null, null, null, 4444, 1, '0:0:0:0:0:0:0:1', 'mchyzer', '691681cbbb7243caa3e4852ced79b3bc')\n2010/05/06 22:21:49:003, 0ms, statement: ByObject.java.save() line 197, Hib3GroupDAO.java.callback() line 119, Hib3GroupDAO.java.addType() line 108, Group.java.callback() line 916, Group.java.addType() line 890, Group.java.addType() line 860, SaveGroupAction.java.doTypes() line 349, SaveGroupAction.java.grouperExecute() line 240, GrouperCapableAction.java.callback() line 217, Hib3TransactionDAO.java.callback() line 51, Hib3TransactionDAO.java.transactionCallback() line 41, GrouperCapableAction.java.grouperTransactionExecute() line 214, GrouperCapableAction.java.execute() line 279, LoginCheckFilter.java.callback() line 173, GrouperSession.java.callbackGrouperSession() line 644, LoginCheckFilter.java.doFilter() line 168, ErrorFilter.java.doFilter() line 132, GrouperUiFilter.java.doFilter() line 398\n   insert into grouper_groups_types (hibernate_version_number, group_uuid, type_uuid, context_id, id) values (0, '6e70a1c3a2d246669244051e44439374', '57433a6dbdf14008a371ef18cd5c9c8d', 'b296ae3dd6b448d28c9ba2e643903087', '402881822870817d01287091964b0002')\nGrouperLoaderArchitectureDiagram.tiff2010/05/06 22:22:08:489, 0ms, statement: ByHqlStatic.java.uniqueResult() line 297, Hib3GroupDAO.java.findByName() line 907, GroupFinder.java.findByName() line 225, GroupFinder.java.findByName() line 198, GroupTypeSecurityHook.java.vetoIfNecessary() line 194, GroupTypeSecurityHook.java.groupTypeTupleHelper() line 300, GroupTypeSecurityHook.java.groupTypeTuplePostInsert() line 289, GrouperUtil.java.invokeMethod() line 3422, GrouperHooksUtils.java.executeHook() line 476, GrouperHooksUtils.java.callHooksIfRegistered() line 276, GrouperHooksUtils.java.callHooksIfRegistered() line 215, GrouperHooksUtils.java.callHooksIfRegistered() line 141, GroupTypeTuple.java.onPostSave() line 265, Hib3GroupDAO.java.callback() line 119, Hib3GroupDAO.java.addType() line 108, Group.java.callback() line 916, Group.java.addType() line 890, Group.java.addType() line 860, SaveGroupAction.java.doTypes() line 349, SaveGroupAction.java.grouperExecute() line 240, GrouperCapableAction.java.callback() line 217, Hib3TransactionDAO.java.callback() line 51, Hib3TransactionDAO.java.transactionCallback() line 41, GrouperCapableAction.java.grouperTransactionExecute() line 214, GrouperCapableAction.java.execute() line 279, LoginCheckFilter.java.callback() line 173, GrouperSession.java.callbackGrouperSession() line 644, LoginCheckFilter.java.doFilter() line 168, ErrorFilter.java.doFilter() line 132, GrouperUiFilter.java.doFilter() line 398\n\n```\n\nThe next commit or rollback in the file is a rollback (after it checks to see if the user is the member of the allowed group or wheel or GrouperSysadmin)\n\n#### Unschedule a database quartz job\n\nNote, you can look in the table grouper\\_qz\\_triggers and grouper\\_qz\\_job\\_details for more info\n\n```\nselect * from grouper_loader_log where lower(job_name) like '%abc%' order by started_time desc;\nselect * from GROUPER_QZ_TRIGGERS where lower(trigger_name) like '%abc%';\nselect * from GROUPER_QZ_CRON_TRIGGERS where lower(trigger_name) like '%abc%';\nselect * from GROUPER_QZ_FIRED_TRIGGERS where lower(trigger_name) like '%abc%';\nselect * from grouper_qz_job_details gqjd where lower(GQJD.JOB_NAME ) like '%abc%';\n```\n\nIf you want to unschedule BLOCKED jobs (the code part is one line of GSH)\n\n```\nGrouperSession.startRootSession();\nfor (String triggerName : HibernateSession.bySqlStatic().listSelect(String.class, \"select trigger_name from GROUPER_QZ_TRIGGERS where trigger_state = 'BLOCKED'\", null)) {GrouperLoader.schedulerFactory().getScheduler().unscheduleJob(org.quartz.TriggerKey.triggerKey(triggerName));}\n```\n\nIf you get errors about a database quartz job, you can unschedule with (or whatever the trigger name is):\n\n```\nselect trigger_name from GROUPER_QZ_TRIGGERS where lower(trigger_name) like '%abc%';\ngsh 2% GrouperLoader.schedulerFactory().getScheduler().unscheduleJob(org.quartz.TriggerKey.triggerKey(\"triggerMessaging_MESSAGING_listener_messagingListener\"))\n```\n\n#### Performance Settings\n\nThese are the default settings:\n\n```\n# if should use threads in the loader for add/remove member\n# {valueType: \"boolean\", required: true}\nloader.use.membershipThreads=true\n\n# number of threads to use for each group job (not shared among jobs)\n# {valueType: \"integer\", required: true}\nloader.membershipThreadPoolSize=10\n\n# if should use threads in the loader for each group in a group of groups\n# {valueType: \"boolean\", required: true}\nloader.use.groupThreads=true\n\n# number of threads to use for each list of groups job (not shared among jobs)\n# {valueType: \"integer\", required: true}\nloader.groupThreadPoolSize=20\n```\n\nSo for a simple job (SQL\\_SIMPLE, LDAP\\_SIMPLE), you can have up to 10 threads.  However for a single groupList job (SQL\\_GROUP\\_LIST, LDAP\\_GROUP\\_LIST, LDAP\\_GROUPS\\_FROM\\_ATTRIBUTES), you can have up to 200 threads since each of the 20 group threads can have 10 membership threads.\n\n### Loader permissions\n\nThis table reflects loader permissions in Grouper v2.5.53+\n\n| Resource | Misc Loader screen | Readonly Loader functions | Read/write Loader function |\n| --- | --- | --- | --- |\n| Description | Screen with all loader jobs listed with config and status | Some functions on each loader job | See and edit the loader configuration for a loader job |\n| Functions | * Job names * Schedule * Stats | * View settings * View logs | * Diagnostics * Enable/disable job * Edit loader settings * Run loader * Schedule job |\n| Grouper sysadmin | Yes | Yes | Yes |\n| etc:loaderEditors | Yes | Yes  \\* if has VIEW on group | Yes  \\* if has VIEW on group |\n| etc:loaderViewers | Yes | Yes  \\* if has VIEW on group | No |\n| Group admins | No | Yes | No |\n| Everyone else | No | No | No |\n\nSome other settings\n\n| Setting | Description |\n| --- | --- |\n| uiV2.group.allowGroupAdminsToRefreshLoaderJobs | If someone is in the configured group, and they are admin on a group, then they can run that loader job |\n|  |  |\n|  |  |\n\n### Add loader job from GSH\n\n```\nimport java.util.Map;\n\nimport edu.internet2.middleware.grouper.Group;\nimport edu.internet2.middleware.grouper.GroupSave;\nimport edu.internet2.middleware.grouper.GrouperSession;\nimport edu.internet2.middleware.grouper.app.loader.GrouperLoader;\nimport edu.internet2.middleware.grouper.attr.assign.AttributeAssign;\nimport edu.internet2.middleware.grouper.attr.assign.AttributeAssignSave;\nimport edu.internet2.middleware.grouper.attr.assign.AttributeAssignType;\nimport edu.internet2.middleware.grouper.cfg.GrouperConfig;\nimport edu.internet2.middleware.grouper.util.GrouperUtil;\n\nString groupName = \"test:testGroup\";\n\nMap<String, String> settingsNameValue = GrouperUtil.toMap(\n    \"dbName\", \"grouper\",\n    \"type\", \"SQL_SIMPLE\",\n    \"scheduleType\", \"CRON\",\n    \"quartzCron\", \"0 0 6 * * ?\",\n    \"query\", \"select 1 from whatever\",\n    \"failsafeUse\", \"T\",\n    \"failsafeSendEmail\", \"T\",\n    \"minGroupSize\", \"50\",\n    \"maxGroupPercentRemove\", \"20\",\n    \"minGroupNumberOfMembers\", \"100\"\n    );\n\nGrouperSession grouperSession = GrouperSession.startRootSession();\n\nGroup group = new GroupSave().assignName(groupName).assignCreateParentStemsIfNotExist(true).save();\n\nString etcStemName = GrouperConfig.retrieveConfig().propertyValueString(\"grouper.rootStemForBuiltinObjects\", \"etc\");\n\nAttributeAssign markerAssign = new AttributeAssignSave(grouperSession).assignOwnerGroup(group).\n    assignNameOfAttributeDefName(etcStemName + \":legacy:attribute:legacyGroupType_grouperLoader\").assignAttributeAssignType(AttributeAssignType.group).save();\n\nfor (String settingName : settingsNameValue.keySet()) {\n  String settingValue = settingsNameValue.get(settingName);\n  \n new AttributeAssignSave(grouperSession).assignOwnerAttributeAssign(markerAssign).\n      assignNameOfAttributeDefName(etcStemName + \":legacy:attribute:legacyAttribute_grouperLoader\" + GrouperUtil.capitalize(settingName)).\n      assignAttributeAssignType(AttributeAssignType.group_asgn).addValue(settingValue).save();\n}\n\nGrouperLoader.scheduleJobs();\n```\n\n### Export / import loader config\n\n[Here is a GSH template example](/pages/viewpage.action?pageId=315130087) to export/import loader configs\n\n### Possible to do's\n\n* add subject source to group attribute (or default at least) so it doesn't have to be a sql column if all are the same\n* make specific blackout times (runtime via config file?)\n* make jobs based on person trigger.  If there is a query that says when people change, then update that person's memberships in the groups that are dynamic based on that person-change-query\n* make full refresh jobs for the incremental jobs (e.g. weekly)\n* make an RMI server so that interactions can happen at runtime (to see status, stop/start jobs, etc).  Maybe this would happen from gsh\n* try the name pattern after loader is done, and if the number of groups is less than the number of groups in this round of loader, set the job status to WARNING and add a descriptive message\n\n### See Also\n\n[Grouper Loader Class List Example from University of Pennsylvania](/display/Grouper/Grouper+Loader+classlist+example+from+Penn)"
}